let DEFAULT_LAT=51.505,DEFAULT_LNG=-.09,DEFAULT_CITY="London",DEFAULT_COUNTRY="United Kingdom",ADDRESS_MULTI_STRING_SEPARATOR="___###___",fetchAddress=async e=>(await fetch(`https://nominatim.openstreetmap.org/search?q=${e}&format=json`,{headers:{"User-Agent":"advanced-custom-post-type"}})).json(),coordinates=(e,t)=>new google.maps.LatLng(e,t),createIcon=e=>({url:e,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)}),addPointOnMap=(e,t,a=0,n=null)=>new google.maps.Marker({map:e,icon:createIcon("https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/geocode-71.png"),position:t,title:n}),addPlaceOnMap=(e,t,a,n)=>{t.geometry&&t.geometry.location?(a.push(addPointOnMap(e,t.geometry.location,t.icon,t.name)),t.geometry.viewport?n.union(t.geometry.viewport):n.extend(t.geometry.location)):console.log("Returned place contains no geometry")},extractMapElements=e=>{var e=e.getAttribute("id"),t=e.slice(0,-4),a=t+"_lat",n=t+"_lng",o=t+"_city",l=t+"_country",d=t+"_selections",s=t+"_google_placeholder",c=document.getElementById(a),r=document.getElementById(n),i=document.getElementById(o),l=document.getElementById(l),u=document.getElementById(e),p=document.getElementById(t),d=document.getElementById(d);return{mapPreviewId:e,searchBoxId:t,googlePlaceholderId:s,googlePlaceholderSelector:document.getElementById(s),searchBoxLat:a,searchBoxLng:n,searchBoxCity:o,searchBoxIdSelector:p,mapPreviewIdSelector:u,selections:d,latSelector:c,lngSelector:r,citySelector:i,countrySelector:l}},initTheMap=(e,t,a)=>new google.maps.Map(e,{center:{lat:parseFloat(t),lng:parseFloat(a)},zoom:18,mapTypeId:"roadmap"}),addSearchControl=(e,t)=>{let a=new google.maps.places.SearchBox(e);return t.controls[google.maps.ControlPosition.TOP_LEFT].push(e),t.addListener("bounds_changed",()=>{a.setBounds(t.getBounds())}),a},extractCity=e=>{let t;return e.address_components&&0<e.address_components.length&&e.address_components.forEach(e=>{(e.types.includes("locality")||e.types.includes("postal_town"))&&(t=e.long_name||e.short_name)}),t},extractCountry=e=>{let t;return e.address_components&&0<e.address_components.length&&e.address_components.forEach(e=>{e.types.includes("country")&&(t=e.long_name||e.short_name)}),t},addItemToSelections=(e,t,a,n,o)=>{e.innerHTML+=`
            <div class="selection" data-index="${a}" data-lat="${n}" data-lng="${o}">
                <span class="acpt_map_multi_selection">
                    ${t}
                </span>
                <a class="acpt_map_delete_multi_selection button button-danger">-</a>
            </div>
        `},addValueToAnInput=(e,t)=>{var a=t.value,a=a?a.split(ADDRESS_MULTI_STRING_SEPARATOR):[];a.push(e),t.value=a.join(ADDRESS_MULTI_STRING_SEPARATOR)},deleteValueFromAnInput=(e,t)=>{var a=t.value,a=a?a.split(ADDRESS_MULTI_STRING_SEPARATOR):[];a[e]&&a.splice(e,1),t.value=a.join(ADDRESS_MULTI_STRING_SEPARATOR)};async function initAutocomplete(){var a=document.getElementsByClassName("acpt_map_preview");for(let t=0;t<a.length;t++){var g=a.item(t);let{mapPreviewId:n,searchBoxIdSelector:c,mapPreviewIdSelector:e,latSelector:r,lngSelector:i,citySelector:u,countrySelector:p}=extractMapElements(g),o=""!==r.value?r.value:DEFAULT_LAT,l=""!==i.value?i.value:DEFAULT_LNG;var d;u.value||DEFAULT_CITY,p.value||DEFAULT_COUNTRY;!c.value||r.value||i.value||0<(d=await fetchAddress(c.value)).length&&(o=d[0].lat,l=d[0].lng);let m=initTheMap(e,o,l);if(void 0!==m.center){g.classList.remove("loading");let t=addSearchControl(c,m),a=addPointOnMap(m,coordinates(o,l)),d=(a.setMap(m),[a]),s=()=>{d.forEach(e=>{e.setMap(null)}),d=[]};t.addListener("places_changed",()=>{var e=t.getPlaces();if(0!==e.length){s();let t=new google.maps.LatLngBounds;e.forEach(e=>{addPlaceOnMap(m,e,d,t),r.value=""!==c.value?e.geometry.location.lat():null,i.value=""!==c.value?e.geometry.location.lng():null,u.value=extractCity(e),p.value=extractCountry(e)}),m.fitBounds(t)}}),document.addEventListener("acpt-reset-map",function(e){e.detail.fieldId===n&&(console.log(`Resetting map ${n}...`),s(),e=coordinates(DEFAULT_LAT,DEFAULT_LNG),(a=addPointOnMap(m,e)).setMap(m),m.panTo(e))}),m.addListener("click",l=>{(new google.maps.Geocoder).geocode({latLng:l.latLng},function(e,t){var a,n,o;t===google.maps.GeocoderStatus.OK&&(t=new google.maps.LatLngBounds,e=e[0],a=l.latLng.lat(),n=l.latLng.lng(),o=coordinates(a,n),s(),addPlaceOnMap(m,e,d,t),r.value=a||null,i.value=n||null,u.value=extractCity(e),p.value=extractCountry(e),c.value=e.formatted_address,m.panTo(o))})})}else e.innerHTML="Please refresh the page to see the map."}}async function initMultiAddress(){var l=document.getElementsByClassName("acpt_map_multi_preview");for(let t=0;t<l.length;t++){var d=l.item(t);let{selections:u,searchBoxIdSelector:p,mapPreviewIdSelector:e,googlePlaceholderSelector:a,latSelector:m,lngSelector:g,citySelector:_,countrySelector:v}=extractMapElements(d);var s=p.value?p.value.split(ADDRESS_MULTI_STRING_SEPARATOR):[];let n=m.value?m.value.split(ADDRESS_MULTI_STRING_SEPARATOR):[],o=g.value?g.value.split(ADDRESS_MULTI_STRING_SEPARATOR):[];_.value&&_.value.split(ADDRESS_MULTI_STRING_SEPARATOR),v.value&&v.value.split(ADDRESS_MULTI_STRING_SEPARATOR);var c=""!==m.value?m.value:DEFAULT_LAT,r=""!==g.value?g.value:DEFAULT_LNG;_.value||DEFAULT_CITY,v.value||DEFAULT_COUNTRY;let T=initTheMap(e,c,r);if(void 0!==T.center){d.classList.remove("loading");c=a;let t=new google.maps.places.SearchBox(c),r=(T.controls[google.maps.ControlPosition.TOP_LEFT].push(c),T.addListener("bounds_changed",()=>{t.setBounds(T.getBounds())}),[]),i=(0<s.length&&s.map((e,t)=>{r.push(addPointOnMap(T,coordinates(n[t],o[t]),null,e))}),t.addListener("places_changed",()=>{var e=t.getPlaces();if(0!==e.length){let d=new google.maps.LatLngBounds;e.forEach(e=>{var t=e.formatted_address,a=extractCity(e),n=extractCountry(e),o=e.geometry.location.lat(),l=e.geometry.location.lng();addPlaceOnMap(T,e,r,d),addItemToSelections(u,t,u.children.length,o,l),addValueToAnInput(t,p),addValueToAnInput(o,m),addValueToAnInput(l,g),addValueToAnInput(a,_),addValueToAnInput(n,v)}),i(),T.fitBounds(d)}}),T.addListener("click",c=>{(new google.maps.Geocoder).geocode({latLng:c.latLng},function(e,t){var a,n,o,l,d,s;t===google.maps.GeocoderStatus.OK&&(t=new google.maps.LatLngBounds,e=e[0],a=c.latLng.lat(),n=c.latLng.lng(),o=coordinates(a,n),l=e.formatted_address,d=extractCity(e),s=extractCountry(e),addPlaceOnMap(T,e,r,t),addItemToSelections(u,l,u.children.length,a,n),addValueToAnInput(l,p),addValueToAnInput(a,m),addValueToAnInput(n,g),addValueToAnInput(d,_),addValueToAnInput(s,v),T.panTo(o),i())})}),()=>{var e,t;for(e of document.getElementsByClassName("acpt_map_multi_selection")){let l=e.parentElement;l.addEventListener("click",function(e){var t,a=l.parentElement,n=a.getElementsByClassName("acpt_map_multi_selection"),a=a.id.replace("_selections",""),o=T.getDiv().id.replace("_map","");for(t of n)t.parentElement.classList.remove("active");e.preventDefault(),l.classList.add("active");n=l.dataset.lat,e=l.dataset.lng;n&&e&&a===o&&(a=coordinates(n,e),T.panTo(a))})}for(t of document.getElementsByClassName("acpt_map_delete_multi_selection")){let o=t.parentElement;t.addEventListener("click",function(e){e.preventDefault();let t=o.dataset.lat,a=o.dataset.lng,n=o.dataset.index;r.map(e=>{parseFloat(t)===e.position.lat()&&parseFloat(a)===e.position.lng()&&(deleteValueFromAnInput(n,p),deleteValueFromAnInput(n,m),deleteValueFromAnInput(n,g),deleteValueFromAnInput(n,_),deleteValueFromAnInput(n,v),e.setMap(null),o.remove())})})}});i()}}}function init(){initAutocomplete(),initMultiAddress()}document.addEventListener("acpt_grouped_element_added",e=>{init()}),document.addEventListener("acpt_flexible_element_added",e=>{init()});