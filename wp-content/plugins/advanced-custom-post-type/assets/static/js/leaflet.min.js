var $=jQuery.noConflict();let DEFAULT_LAT=51.505,DEFAULT_LNG=-.09,DEFAULT_CITY="London",DEFAULT_COUNTRY="United Kingdom",ADDRESS_MULTI_STRING_SEPARATOR="___###___";window.onload=function(){let v=(e,t,a)=>{e.panTo(new L.LatLng(t,a))},A=e=>"object"==typeof L&&(e=L.DomUtil.get(e))&&null!=e._leaflet_id,T=e=>e.city||e.town||e.county,g=e=>e.country||null,y=async(e,t)=>(await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json`,{headers:{"User-Agent":"advanced-custom-post-type"}})).json(),E=e=>{var t=new GeoSearch.GeoSearchControl({provider:new GeoSearch.OpenStreetMapProvider,style:"bar",keepResult:!1,searchLabel:"Type the address or point a location on the map"});return e.addControl(t),t},h=(e,t,a,n)=>{e=L.map(e).setView([a,n],17);return L.tileLayer("//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(e),t.classList.remove("loading"),e},I=e=>{var e=e.getAttribute("id"),t=e.slice(0,-4),a=t+"_lat",n=t+"_lng",l=t+"_city",o=t+"_country",i=t+"_selections",r=document.getElementById(t),c=document.getElementById(a),p=document.getElementById(n),u=document.getElementById(l),o=document.getElementById(o);return{mapPreviewId:e,searchBoxId:t,searchBoxLat:a,searchBoxLng:n,searchBoxCity:l,searchInput:r,selections:document.getElementById(i),latInput:c,lngInput:p,cityInput:u,countryInput:o}};async function t(){if("object"==typeof L){var l=document.getElementsByClassName("acpt_map_preview");for(let a=0;a<l.length;a++){var s=l.item(a);let{mapPreviewId:n,searchInput:i,latInput:r,lngInput:c,cityInput:p,countryInput:u}=I(s),e=r.value||DEFAULT_LAT,t=c.value||DEFAULT_LNG;p.value||DEFAULT_CITY,u.value||DEFAULT_COUNTRY;if(i.addEventListener("input",function(){r.value="",c.value="",p.value="",u.value=""}),!A(n)){!i.value||r.value||c.value||(m=i.value,0<(m=await(await fetch(`https://nominatim.openstreetmap.org/search?q=${m}&format=json`,{headers:{"User-Agent":"advanced-custom-post-type"}})).json()).length&&(e=m[0].lat,t=m[0].lng));let l=h(n,s,e,t),o=null,a=((o=L.marker([e,t]).addTo(l)).bindPopup(i.value).openPopup(),E(l));async function d(e){null!==o&&l.removeLayer(o);var t=await y(e.location.y,e.location.x);i.value=a.searchElement&&a.searchElement.input?a.searchElement.input.value:e.location.label,r.value=e.location.y,c.value=e.location.x,p.value=T(t.address),u.value=g(t.address),e.marker.bindPopup(i.value).openPopup()}async function _(e){if("click"===e.type){let t=0;l.eachLayer(function(e){0!==t&&l.removeLayer(e),t++});var a=[e.latlng.lat,e.latlng.lng],n=await y(a[0],a[1]);i.value=n.display_name,r.value=a[0],c.value=a[1],p.value=T(n.address),u.value=g(n.address),null!==o&&l.removeLayer(o),(o=L.marker(a).addTo(l)).bindPopup(n.display_name).openPopup(),v(l,e.latlng.lat,e.latlng.lng)}}l.on("geosearch/showlocation",d),l.on("click",_),document.addEventListener("acpt-reset-map",function(e){if(e.detail.fieldId===n){console.log(`Resetting map ${n}...`);let t=0;l.eachLayer(function(e){0!==t&&l.removeLayer(e),t++}),v(l,DEFAULT_LAT,DEFAULT_LNG),o=L.marker([DEFAULT_LAT,DEFAULT_LNG]).addTo(l)}})}}}var m}let m=(e,t)=>{var a=t.value,a=a?a.split(ADDRESS_MULTI_STRING_SEPARATOR):[];a.push(e),t.value=a.join(ADDRESS_MULTI_STRING_SEPARATOR)},R=(e,t)=>{var a=t.value,a=a?a.split(ADDRESS_MULTI_STRING_SEPARATOR):[];a[e]&&a.splice(e,1),t.value=a.join(ADDRESS_MULTI_STRING_SEPARATOR)},S=async(e,t,a,n,l,o,i,r,c,p)=>{var u=[e,t],s=await y(e,t),d=T(s.address),_=g(s.address);m(s.display_name,o),m(e,i),m(t,r),m(d,c),m(_,p),L.marker(u).addTo(n).bindPopup(s.display_name).openPopup(),v(n,e,t),D(l,s.display_name,l.children.length,e,t)},D=(e,t,a,n,l)=>{e.innerHTML+=`
            <div class="selection" data-index="${a}" data-lat="${n}" data-lng="${l}">
                <span class="acpt_map_multi_selection">
                    ${t}
                </span>
                <a class="acpt_map_delete_multi_selection button button-danger">-</a>
            </div>
        `};async function a(){if("object"==typeof L){var c=document.getElementsByClassName("acpt_map_multi_preview");for(let a=0;a<c.length;a++){var s=c.item(a);let{mapPreviewId:e,selections:t,searchInput:o,latInput:i,lngInput:r,cityInput:p,countryInput:u}=I(s);var d=o.value?o.value.split(ADDRESS_MULTI_STRING_SEPARATOR):[];let n=i.value?i.value.split(ADDRESS_MULTI_STRING_SEPARATOR):[],l=r.value?r.value.split(ADDRESS_MULTI_STRING_SEPARATOR):[];var _=p.value?p.value.split(ADDRESS_MULTI_STRING_SEPARATOR):[],m=u.value?u.value.split(ADDRESS_MULTI_STRING_SEPARATOR):[],v=0<n.length?n[n.length-1]:DEFAULT_LAT,T=0<l.length?l[l.length-1]:DEFAULT_LNG;0<_.length?_[_.length-1]:DEFAULT_CITY,0<m.length?m[m.length-1]:DEFAULT_COUNTRY;if(!A(e)){let c=h(e,s,v,T),a=null;0<d.length&&d.map((e,t)=>{(a=L.marker([n[t],l[t]]).addTo(c)).bindPopup(e).openPopup()});E(c);async function g(e){await S(e.location.y,e.location.x,a,c,t,o,i,r,p,u)}async function y(e){await S(e.latlng.lat,e.latlng.lng,a,c,t,o,i,r,p,u)}c.on("geosearch/showlocation",g),c.on("click",y),$("body").on("click",".acpt_map_multi_selection",function(e){let t=$(this),a=t.parent().data("lat"),n=t.parent().data("lng");var l=t.parent(),o=t.parent().parent(),i=o.attr("id").replace("_selections",""),r=c.boxZoom._container.id.replace("_map","");o.find(".selection").each((e,t)=>{t.classList.remove("active")}),l.addClass("active"),a&&n&&i===r&&(c.panTo(new L.LatLng(a,n)),c.eachLayer(function(e){e._latlng&&e._latlng.lat===a&&e._latlng.lng===n&&!1===e.isPopupOpen()&&e.bindPopup(t.text()).openPopup()}))}),$("body").on("click",".acpt_map_delete_multi_selection",function(e){let t=$(this),a=t.parent().data("lat"),n=t.parent().data("lng"),l=t.parent().data("index");c.eachLayer(function(e){e._latlng&&e._latlng.lat===a&&e._latlng.lng===n&&(R(l,o),R(l,i),R(l,r),R(l,p),R(l,u),c.removeLayer(e),t.parent().remove())})})}}}}document.addEventListener("acpt_grouped_element_added",e=>{t(),a()}),document.addEventListener("acpt_flexible_element_added",e=>{t(),a()}),t(),a()};