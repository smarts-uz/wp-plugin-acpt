class ACPTTabulator{defaultCellValue="Double click to edit";defaultCellObject={value:this.defaultCellValue,settings:{}};constructor(e){this.selector=e,this.target=document.getElementById(e),this.tableId=this.#randomId(),this.json={}}#randomId(){return Math.random().toString(36).slice(2)}#numberToLetter(e){var t=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];return t[e]?t[e].toUpperCase():null}#dispatchChangeEvent(){var e=new CustomEvent("acpt-tabulator-change",{detail:{json:this.json,id:this.selector}});document.dispatchEvent(e)}destroyTable(){var e=document.getElementById(this.tableId);e&&(e.remove(),this.target.innerHTML=`<p class="update-nag notice notice-warning" style="margin: 0;">${useTranslation("No table already created.")}</p>`,this.json={},this.#dispatchChangeEvent())}createTable(t){if(this.target){if(!this.#validateJSON(t))throw this.target.innerHTML=`<p class="update-nag notice notice-danger" style="margin: 0;">${useTranslation("JSON data is not valid.")}</p>`,new Error("json is not valid");var s=t.settings.layout,a=t.settings.css,l=t.settings.header,o=t.settings.footer,n=t.settings.columns,i=t.settings.rows,r=t.data;if(0===Number(i)||0===Number(n))this.destroyTable();else{let e;"string"==typeof(e="vertical"===s?this.#createVerticalTable(n,i,r,a,o):this.#createHorizontalTable(n,i,r,a,l,o))&&(this.target.innerHTML=e,this.json=t,this.#makeTableEditable(document.getElementById(this.tableId)),this.#dispatchChangeEvent())}}}#createHorizontalTable(t,s,a,e,l=!0,o=!1){let n='<table id="'+this.tableId+`" class="acpt-editable-table ${e}">`,i=0,r=0;n=(n+="<thead>")+'<tr><th class="white" width="10"></th>';for(let e=0;e<Number(t);e++)n=(n=(n=(n+='<th style="text-align: center;" class="helper">')+'<a href="#" data-col-id="'+e+`" title="${useTranslation("Delete column")}" class="delete-col">-</a>`)+'<a href="#" data-col-id="'+e+`" title="${useTranslation("Add column")}" class="add-col prev">+</a>`)+`<span>${this.#numberToLetter(e)}</span>`,e===Number(t)-1&&(n+='<a href="#" data-col-id="'+(e+1)+`" title="${useTranslation("Add column")}" class="add-col next">+</a>`),n+="</td>";if(n=n+'<th class="white" width="10"></th>'+"</tr>",l){n=n+('<tr data-row-id="'+i+'">')+'<th class="white" width="10"></th>';for(let e=0;e<Number(t);e++)n=(n+='<th data-row-id="'+i+'" data-col-id="'+e+'" class="editable">')+a[r][e].value+"</th>";n=n+(`<th class="white" width="10">
                <a href="#" data-row-id="`+i+`" title="${useTranslation("Delete row")}" class="delete-row">-</a>
            </th>`)+"</tr>",r++,i++}n+="</thead><tbody>";for(let e=0;e<Number(s);e++){n=(n=(n=n+('<tr data-row-id="'+i+'">')+'<td class="no-resize helper">')+('<a href="#" data-row-id="'+i+`" title="${useTranslation("Add row")}" class="add-row prev">+</a>`))+`<span >${i}</span>`,e===Number(s)-1&&(n+='<a href="#" data-row-id="'+(i+1)+`" title="${useTranslation("Add row")}" class="add-row next">+</a>`),n+="</td>";for(let e=0;e<Number(t);e++)n=(n+='<td data-row-id="'+i+'" data-col-id="'+e+'" class="editable">')+a[r][e].value+"</td>";n=n+(`<td class="no-resize white">
                <a href="#" data-row-id="`+i+`" title="${useTranslation("Delete row")}" class="delete-row">
                    -
                 </a>
            </td>`)+"</tr>",r++,i++}if(n+="</tbody>",o){n=(n+="<tfoot>")+('<tr data-row-id="'+i+'">')+"<td></td>";for(let e=0;e<Number(t);e++)n=(n+='<td data-row-id="'+i+'" data-col-id="'+e+'" class="editable">')+a[r][e].value+"</td>";n=(n+=`<td class="no-resize white">
                <a href="#" data-row-id="`+i+`" title="Delete row" class="delete-row">
                    -
                 </a>
            </td>`)+"</tr>"+"</tfoot>"}return n+="</table>"}#createVerticalTable(t,s,a,e,l=!1){let o='<table id="'+this.tableId+`" class="acpt-editable-table ${e}">`,n=0,i=0;o=(o+="<thead>")+'<tr><th class="white" width="10"></th>';for(let e=0;e<Number(t);e++)o=(o=(o=(o+='<th style="text-align: center;" class="helper">')+'<a href="#" data-col-id="'+e+`" title="${useTranslation("Delete column")}" class="delete-col">-</a>`)+'<a href="#" data-col-id="'+e+`" title="${useTranslation("Add column")}" class="add-col prev">+</a>`)+`<span>${this.#numberToLetter(e)}</span>`,e===Number(t)-1&&(o+='<a href="#" data-col-id="'+(e+1)+`" title="${useTranslation("Add column")}" class="add-col next">+</a>`),o+="</td>";o=(o+='<th class="white" width="10"></th></tr>')+"</thead><tbody>";for(let e=0;e<Number(s);e++){o=(o=(o=o+('<tr data-row-id="'+n+'">')+'<td class="no-resize helper">')+('<a href="#" data-row-id="'+n+`" title="${useTranslation("Add row")}" class="add-row prev">+</a>`))+`<span >${n}</span>`,e===Number(s)-1&&(o+='<a href="#" data-row-id="'+(n+1)+`" title="${useTranslation("Add row")}" class="add-row next">+</a>`),o+="</td>";for(let e=0;e<Number(t);e++)0===e?o+='<th data-row-id="'+n+'" data-col-id="'+e+'" class="editable">':o+='<td data-row-id="'+n+'" data-col-id="'+e+'" class="editable">',o+=""+a[i][e].value,0===e?o+="</th>":o+="</td>";o=o+(`<td class="no-resize white">
                <a href="#" data-row-id="`+n+`" title="${useTranslation("Delete row")}" class="delete-row">
                    -
                 </a>
            </td>`)+"</tr>",i++,n++}if(l){o=(o+="<tfoot>")+('<tr data-row-id="'+n+'">')+"<td></td>";for(let e=0;e<Number(t);e++)0===e?o+='<th data-row-id="'+n+'" data-col-id="'+e+'" class="editable">':o+='<td data-row-id="'+n+'" data-col-id="'+e+'" class="editable">',o+=""+a[i][e].value,0===e?o+="</th>":o+="</td>";o=(o+=`<td class="no-resize white">
                <a href="#" data-row-id="`+n+`" title="${useTranslation("Delete row")}" class="delete-row">
                    -
                 </a>
            </td>`)+"</tr>"+"</tfoot>"}return o=o+"</tbody>"+"</table>"}#validateJSON(e){return!!e.settings&&!!e.settings.layout&&!(!["vertical","horizontal"].includes(e.settings.layout)||"boolean"!=typeof e.settings.header||"boolean"!=typeof e.settings.footer||isNaN(e.settings.columns)||isNaN(e.settings.rows)||!e.data||"object"!=typeof e.data)}#makeTableEditable(e){var t=e.querySelectorAll("th"),e=e.querySelectorAll("td");let s=e=>{var t,s,a;e.classList.contains("editable")&&(this.#applyCSSToCell(e),this.#addContextMenu(e),this.#clickAndSelectCell(e),t=Number(e.dataset.rowId),s=Number(e.dataset.colId),a=document.getElementById(`context-menu-${t}-`+s),this.#clickOutsideTheCell(e,a),this.#doubleClickAndMakeCellEditable(e,a),this.#blurAndRemoveDestroyCellEditable(e,a),this.#detectAnyChangeInCellContent(e,a,t,s),this.#toggleContextMenu(e,a))};t.forEach(e=>{s(e)}),e.forEach(e=>{s(e)})}#selectCell(e){e.classList.add("selected")}#deselectCell(e){e.classList.remove("selected")}#applyCSSToCell(e){var t=this.json,s=Number(e.dataset.colId),a=Number(e.dataset.rowId),s=t.data[a]&&t.data[a][s]?t.data[a][s].settings:{},l=s&&s.width?s.width:"",o=(s&&s.alignment?s:t.settings).alignment,n=(s&&s.color?s:t.settings).color,i=s&&s.css?s.css:"",r=s&&s.backgroundColor?{color:s.backgroundColor,zebra:s.backgroundColor}:t.settings.background,s={style:s&&s.borderStyle?s.borderStyle:t.settings.border.style,color:s&&s.borderColor?s.borderColor:t.settings.border.color,thickness:s&&s.borderThickness?s.borderThickness:t.settings.border.thickness};""!==i&&e.classList.add(i),e.style.width=l,e.style.color=n,e.style.textAlign=o,e.style.borderStyle=s.style,e.style.borderColor=s.color,e.style.borderWidth=s.thickness+"px",e.style.background=a%2?r.zebra:r.color}#addContextMenu(t){let s=this,a=Number(t.dataset.colId),l=Number(t.dataset.rowId);var e=this.json.data[l]&&this.json.data[l][a]?this.json.data[l][a].settings:{},o=this.json.settings,n=`context-menu-${l}-`+a,i=e&&e.width?e.width:"",r=(e&&e.alignment?e:o).alignment,d=(e&&e.color?e:o).color,c=e&&e.css?e.css:"",u=e&&e.backgroundColor?{color:e.backgroundColor,zebra:e.backgroundColor}:o.background,e={style:e&&e.borderStyle?e.borderStyle:o.border.style,color:e&&e.borderColor?e.borderColor:o.border.color,thickness:e&&e.borderThickness?e.borderThickness:o.border.thickness},o=document.createElement("div"),r=(o.id=n,o.classList.add("acpt-context-menu"),o.innerHTML=`
            <h3>Cell #${this.#numberToLetter(a)}${l} settings</h3>
            <div class="input-wrapper">
                <label for="${n}-alignment">${useTranslation("Alignment")}</label>
                <select id="${n}-alignment">
                    <option ${"left"===r?"selected":""} value="left">${useTranslation("left")}</option>
                    <option ${"center"===r?"selected":""} value="center">${useTranslation("center")}</option>
                    <option ${"right"===r?"selected":""} value="right">${useTranslation("right")}</option>
                </select>
            </div> 
            <div class="input-wrapper">
                <label for="${n}-width">${useTranslation("Width")}</label>
                <input id="${n}-width" type="text" value="${i}" />
            </div> 
            <div class="input-wrapper">
                <label for="${n}-border">${useTranslation("Border")}</label>
                <div class="inputs">
                    <select id="${n}-border-thickness">
                        <option ${1===Number(e.thickness)?"selected":""} value="1">1px</option>
                        <option ${2===Number(e.thickness)?"selected":""} value="2">2px</option>
                        <option ${3===Number(e.thickness)?"selected":""} value="3">3px</option>
                        <option ${4===Number(e.thickness)?"selected":""} value="4">4px</option>
                        <option ${5===Number(e.thickness)?"selected":""} value="5">5px</option>
                        <option ${6===Number(e.thickness)?"selected":""} value="6">6px</option>
                        <option ${7===Number(e.thickness)?"selected":""} value="7">7px</option>
                        <option ${8===Number(e.thickness)?"selected":""} value="8">8px</option>
                        <option ${9===Number(e.thickness)?"selected":""} value="9">9px</option>
                        <option ${10===Number(e.thickness)?"selected":""} value="10">10px</option>
                        <option ${11===Number(e.thickness)?"selected":""} value="11">11px</option>
                        <option ${12===Number(e.thickness)?"selected":""} value="12">12px</option>
                        <option ${13===Number(e.thickness)?"selected":""} value="13">13px</option>
                        <option ${14===Number(e.thickness)?"selected":""} value="14">14px</option>
                        <option ${15===Number(e.thickness)?"selected":""} value="15">15px</option>
                        <option ${16===Number(e.thickness)?"selected":""} value="16">16px</option>
                        <option ${17===Number(e.thickness)?"selected":""} value="17">17px</option>
                        <option ${18===Number(e.thickness)?"selected":""} value="18">18px</option>
                        <option ${19===Number(e.thickness)?"selected":""} value="19">19px</option>
                        <option ${20===Number(e.thickness)?"selected":""} value="20">20px</option>
                    </select>
                    <select id="${n}-border-style">
                        <option ${"solid"===e.style?"selected":""} value="solid">Solid</option>
                        <option ${"dotted"===e.style?"selected":""} value="dotted">Dotted</option>
                        <option ${"dashed"===e.style?"selected":""} value="dashed">Dashed</option>
                        <option ${"double"===e.style?"selected":""} value="double">Double</option>
                        <option ${"groove"===e.style?"selected":""} value="groove">Groove</option>
                        <option ${"ridge"===e.style?"selected":""} value="ridge">Ridge</option>
                        <option ${"inset"===e.style?"selected":""} value="inset">Inset</option>
                        <option ${"outset"===e.style?"selected":""} value="outset">Outset</option>
                        <option ${"none"===e.style?"selected":""} value="none">None</option>
                        <option ${"hidden"===e.style?"selected":""} value="hidden">Hidden</option>
                    </select>
                    <input id="${n}-border-color" type="text" value="${e.color}" />
                </div>
            </div> 
            <div class="input-wrapper">
                <label for="${n}-color">${useTranslation("Text color")}</label>
                <input id="${n}-color" type="text" value="${d}" />
            </div> 
            <div class="input-wrapper">
                <label for="${n}-background-color">${useTranslation("Background")}</label>
                <input id="${n}-background-color" type="text" value="${u.color}" />
            </div> 
            <div class="input-wrapper">
                <label for="${n}-css">${useTranslation("CSS classes")}</label>
                <input id="${n}-css" type="text" value="${c}" />
            </div> 
        `,t.appendChild(o),o.querySelector(`#${n}-width`)),i=o.querySelector(`#${n}-alignment`),e=o.querySelector(`#${n}-border-thickness`),d=o.querySelector(`#${n}-border-style`),u=o.querySelector(`#${n}-border-color`),c=o.querySelector(`#${n}-color`),h=o.querySelector(`#${n}-background-color`),o=o.querySelector(`#${n}-css`);r.addEventListener("keyup",function(e){e=e.target.value;t.style.width=e,s.json.data[l][a].settings={...s.json.data[l][a].settings,width:e},s.#dispatchChangeEvent()}),i.addEventListener("change",function(e){e=e.target.value;t.style.textAlign=e,s.json.data[l][a].settings={...s.json.data[l][a].settings,alignment:e},s.#dispatchChangeEvent()}),e.addEventListener("change",function(e){e=e.target.value;t.style.borderWidth=e+"px",s.json.data[l][a].settings={...s.json.data[l][a].settings,borderThickness:e},s.#dispatchChangeEvent()}),d.addEventListener("change",function(e){e=e.target.value;t.style.borderStyle=e,s.json.data[l][a].settings={...s.json.data[l][a].settings,borderStyle:e},s.#dispatchChangeEvent()}),u.addEventListener("keyup",function(e){e=e.target.value;t.style.borderColor=e,s.json.data[l][a].settings={...s.json.data[l][a].settings,borderColor:e},this.#dispatchChangeEvent()}),c.addEventListener("keyup",function(e){e=e.target.value;t.style.color=e,s.json.data[l][a].settings={...s.json.data[l][a].settings,color:e},s.#dispatchChangeEvent()}),h.addEventListener("keyup",function(e){e=e.target.value;t.style.background=e,s.json.data[l][a].settings={...s.json.data[l][a].settings,backgroundColor:e},s.#dispatchChangeEvent()}),o.addEventListener("keyup",function(e){e=e.target.value;t.classList.add(e),s.json.data[l][a].settings={...s.json.data[l][a].settings,css:e},s.#dispatchChangeEvent()})}#clickAndSelectCell(t){let s=this;t.addEventListener("click",function(e){e.preventDefault(),s.#selectCell(t)})}#clickOutsideTheCell(t,s){let a=this;window.addEventListener("click",function(e){t.contains(e.target)||(s.style.display="none",a.#deselectCell(t))})}#doubleClickAndMakeCellEditable(t,e){let s=this;t.addEventListener("dblclick",function(e){s.#deselectCell(t),s.#editACell(t)})}#blurAndRemoveDestroyCellEditable(e,t){let s=this;e.addEventListener("blur",function(){s.#deselectCell(e),e.removeAttribute("contenteditable","true"),e.removeAttribute("spellcheck","false")},!0)}#detectAnyChangeInCellContent(t,e,a,l){let o=this;t.addEventListener("keydown",function(e){9===event.which&&(e.preventDefault(),null!==(e=o.json.data[a]&&o.json.data[a][l+1]?document.querySelector(`[data-col-id="${l+1}"][data-row-id="${a}"]`):o.json.data[a+1]&&o.json.data[a+1][0]?document.querySelector(`[data-col-id="0"][data-row-id="${a+1}"]`):document.querySelector('[data-col-id="0"][data-row-id="0"]')))&&(o.#deselectCell(t),o.#editACell(e))}),t.addEventListener("input",function(e){if(e.target.classList.contains("editable")&&o.json.data[a]&&o.json.data[a][l]){let s=t.innerText;o.json.data[a].map((e,t)=>{t===l&&(o.json.data[a][l]={value:o.#sanitizeStringForJSON(s),settings:e.settings})}),o.#dispatchChangeEvent()}})}#sanitizeStringForJSON(e){return e.replace(/[\"]/g,"'").replace(/[\\]/g,"\\\\").replace(/[\/]/g,"\\/").replace(/[\b]/g,"\\b").replace(/[\f]/g,"\\f").replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r").replace(/[\t]/g,"\\t")}#toggleContextMenu(t,s){let a=this;t.addEventListener("contextmenu",function(e){e.preventDefault(),a.#selectCell(t),document.querySelectorAll(".acpt-context-menu").forEach(function(e){e.style.display="none"}),s.style.display="block"},!1)}#makeTableResizableAndSortable(e){var t=e.querySelector("tbody"),t=(new Sortable(t,{animation:150}),e.querySelectorAll("th"));interact(t).draggable({edges:{left:!0,right:!0,bottom:!1,top:!1},listeners:{start(e){e.target.classList.add("dragging")},move(e){e.target.style.transform=`translate(${e.dx}px)`},end(e){e=e.target;e.style.transform="",e.classList.remove("dragging")}}}).resizable({edges:{right:!0},restrictEdges:{outer:"parent"},restrictSize:{min:{width:50}},listeners:{move(e){var t=e.target,s=parseFloat(t.style.width)||0;t.style.width=s+e.dx+"px"}}})}#createResizableTable(s){var e=s.querySelectorAll("th");[].forEach.call(e,function(e){var t=document.createElement("div");t.classList.add("resizer"),t.style.height=s.offsetHeight+"px",e.appendChild(t),((t,s)=>{let a=0,l=0;let o=function(e){e=e.clientX-a;t.style.width=l+e+"px"},n=function(){s.classList.remove("resizing"),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",n)};s.addEventListener("mousedown",function(e){a=e.clientX;e=window.getComputedStyle(t);l=parseInt(e.width,10),document.addEventListener("mousemove",o),document.addEventListener("mouseup",n),s.classList.add("resizing")})})(e,t)})}addRow(s){var e=document.getElementById(this.tableId);if(e){let l=this;e=e.querySelectorAll("tr");let t={...this.json},o=!1;e.forEach(function(e){let a=e.dataset.rowId;if(void 0!==a&&Number(a)===Number(s)){let s=[];t.data.map((e,t)=>{Number(a)===Number(t)&&(o=!0,s.push(l.#newRowElement())),s.push(e)}),t.data=s}}),!1===o&&t.data.push(this.#newRowElement()),t.settings.rows=Number(t.settings.rows)+1,this.createTable(t)}}#editACell(e){e.setAttribute("contenteditable","true"),e.setAttribute("spellcheck","false"),e.focus(),e.innerText.includes(this.defaultCellValue)&&(e.innerText="")}#newRowElement(){var t=[];for(let e=0;e<Number(this.json.settings.columns);e++)t.push(this.defaultCellObject);return t}deleteRow(t){var e=document.getElementById(this.tableId);if(e){let l=this;e=e.querySelectorAll("tr");Number(l.json.settings.rows)<Number(t)?(l.json.settings.footer=!1,l.json.data=l.json.data.filter((e,t)=>t!==l.json.data.length-1)):e.forEach(function(e){let a=e.dataset.rowId;if(Number(a)===Number(t)){!0===l.json.settings.header&&0===Number(a)?l.json.settings.header=!1:l.json.settings.rows=l.json.settings.rows-1;let s=[];l.json.data.map((e,t)=>{Number(a)!==Number(t)&&s.push(e)}),l.json.data=s}}),this.createTable(l.json)}}addColumn(t){var e;document.getElementById(this.tableId)&&((e={...this.json}).data.map(e=>{e.splice(t,0,this.defaultCellObject)}),e.settings.columns=Number(e.settings.columns)+1,this.createTable(e))}deleteColumn(t){var e;document.getElementById(this.tableId)&&((e={...this.json}).data.map(e=>{e.splice(t,1)}),e.settings.columns=Number(e.settings.columns)-1,this.createTable(e))}}